resource "aws_security_group" "rapid7_insightvm" {
  name        = "rapid7_insightvm"
  description = "Allow inbound TLS traffic"
  vpc_id      = data.aws_vpc.shared.id
}

resource "aws_security_group_rule" "rapid7_insightvm_ingress" {
  security_group_id = aws_security_group.rapid7_insightvm.id

  from_port   = 0
  to_port     = 0
  protocol    = "TCP"
  description = "Everything from everywhere"
  cidr_blocks = ["0.0.0.0/0"]
  type        = "ingress"
}

resource "aws_security_group_rule" "rapid7_insightvm_egress" {
  security_group_id = aws_security_group.rapid7_insightvm.id

  from_port   = 0
  to_port     = 0
  protocol    = "TCP"
  description = "Everything to everywhere"
  cidr_blocks = ["0.0.0.0/0"]
  type        = "egress"
}

# resource "aws_security_group_rule" "rapid7_insightvm_ssm_ingress" {
#   security_group_id = aws_security_group.rapid7_insightvm.id

#   from_port   = 443
#   to_port     = 443
#   protocol    = "TCP"
#   description = "HTTPS from everywhere"
#   cidr_blocks = ["0.0.0.0/0"]
#   type        = "ingress"
# }

# resource "aws_security_group_rule" "rapid7_insightvm_ingress" {
#   for_each = {
#     "TCP_3780" = {
#       from_port   = "3780"
#       to_port     = "3780"
#       protocol    = "TCP"
#       description = "Web interface access to the Security Console"
#     }
#     "TCP_HTTPS" = {
#       from_port   = "443"
#       to_port     = "443"
#       protocol    = "TCP"
#       description = "HTTPS traffic"
#     }
#     "TCP_HTTP" = {
#       from_port   = "80"
#       to_port     = "80"
#       protocol    = "TCP"
#       description = "HTTP traffic"
#     }
#   }

#   security_group_id        = aws_security_group.rapid7_insightvm.id
#   source_security_group_id = aws_security_group.rapid7_insightvm.id

#   from_port   = each.value.from_port
#   to_port     = each.value.to_port
#   protocol    = each.value.protocol
#   description = each.value.description
#   type        = "ingress"
# }

# resource "aws_security_group_rule" "rapid7_insightvm_egress" {
#   for_each = {
#     "TCP_40814" = {
#       from_port   = "40814"
#       to_port     = "40814"
#       protocol    = "TCP"
#       description = "Management of scan activity on Scan Engines and the retrieval of scan data"
#     }
#     "TCP_443" = {
#       from_port   = "443"
#       to_port     = "443"
#       protocol    = "TCP"
#       description = "Allows the Security Console to download content and feature updates"
#     }
#     "ALL" = {
#       description = "Allow all Egress"
#       from_port   = 0
#       to_port     = 0
#       protocol    = "-1"
#       cidr_blocks = ["0.0.0.0/0"]
#     }
#   }

#   security_group_id        = aws_security_group.rapid7_insightvm.id
#   source_security_group_id = aws_security_group.rapid7_insightvm.id

#   from_port   = each.value.from_port
#   to_port     = each.value.to_port
#   protocol    = each.value.protocol
#   description = each.value.description
#   type        = "egress"
# }

# resource "aws_security_group_rule" "rapid7_insightvm_ssm_egress" {
#   security_group_id = aws_security_group.rapid7_insightvm.id

#   from_port   = 443
#   to_port     = 443
#   protocol    = "TCP"
#   description = "HTTPS from everywhere"
#   cidr_blocks = ["0.0.0.0/0"]
#   type        = "egress"
# }
